name: Preview Deploy

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - unlabeled

concurrency:
  group: preview-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  preview:
    name: Preview
    runs-on: ubuntu-latest
    # Safety gate: only deploy previews when manually triggered or when PR has label "preview"
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'preview'))

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20
          cache: yarn

      - name: Install
        run: yarn install --frozen-lockfile

      - name: Quality
        run: |
          yarn format:check
          yarn lint
          yarn test

      - name: Deploy preview
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          # Optional but often required for non-interactive deploys:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          npx wrangler deploy --name skill-icons-pr-${{ github.event.pull_request.number || github.run_id }}
